{% extends 'base.html' %}

{% block meta %}
<title>Series</title>
{% endblock meta %}

{% block content %}
<div class="container py-4" style="margin-top: 20px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); background-color: #fff;">
    <h1 class="row justify-content-center">
        Series
    </h1>
    <div class="row justify-content-center">
        <div class="col-md-8">
            <table class="table">
                <thead>
                    <tr>
                        <th>Information</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Judul</td>
                        <td>{{series.judul}}</td>
                    </tr>
                    <tr>
                        <td>Episode</td>
                        <td>
                            <ul>
                                {% for episode in list_episode %}
                                <li><a href="../episode/{{episode.id_series}}-{{forloop.counter}}">{{episode.sub_judul}}</a></li>
                                {% endfor %}
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td>Total View</td>
                        <td>{{total_views}}</td>
                    </tr>
                    <tr>
                        <td>Rating Rata-rata</td>
                        <td>{{rating_avg}}</td>
                    </tr>
                    <tr>
                        <td>Sinopsis</td>
                        <td>{{series.sinopsis}}</td>
                    </tr>
                    <tr>
                        <td>Genre</td>
                        <td>
                            <ul>
                                {% for genre in list_genre %}
                                <li>{{genre.genre}}</li>
                                {% endfor %}
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td>Asal Negara</td>
                        <td>{{series.asal_negara}}</td>
                    </tr>
                    <tr>
                        <td>Pemain</td>
                        <td>
                            <ul>
                                {% for pemain in list_pemain %}
                                <li>{{pemain.nama}}</li>
                                {% endfor %}
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td>Penulis Skenario</td>
                        <td>
                            <ul>
                                {% for skenario in list_skenario %}
                                <li>{{skenario.nama}}</li>
                                {% endfor %}
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td>Sutradara</td>
                        <td>{{sutradara.nama}}</td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="btn btn-secondary mt-3" id="downloadButton">Download</button>
            <button type="button" class="btn btn-success mt-3" id="favoriteButton">Favorite</button>
        </div>
    </div>
    <hr class="my-4">
    <div class="mb-5">
        <h2>Ulasan</h2>
    </div>
    <form id="ratingForm">
        <input type="hidden" class="form-control" id="id_tayangan" name="id_tayangan" required value={{series.id_tayangan}}>
        <div class="form-group">
            <label for="rating">Rating:</label>
            <select class="form-control" id="rating" name="rating">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
                <option value="5" selected>5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
            </select>
        </div>
        <div class="form-group">
            <label for="deskripsi">Deskripsi:</label>
            <textarea class="form-control" id="deskripsi" name="deskripsi" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>
    <div class="mb-3 w-50">
        <label for="exampleFormControlTextarea1" class="form-label fs-5 fw-medium">Ulasan pengguna lainnya</label>
    </div>
    <div class="container">
        {% for ulasan in list_ulasan %}
        <div class="shadow p-4 mb-5 bg-body-tertiary rounded">
            <div class="d-flex justify-content-between">
                <div class="mt-2 mb-4 fs-5 fw-semibold">
                    {{ulasan.username}}
                    <p style="font-size: small;">{{ulasan.timestamp}}</p>
                </div>
                <div class="d-flex flex-row gap-2 align-items-start">
                    <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-star-fill text-warning" viewBox="0 0 16 16">
                        <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
                    </svg>
                    <div class="d-flex flex-row">
                        <p class="fs-5 fw-semibold">{{ulasan.rating}}</p><span class="fs-6 fw-light">/10</span>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded p-4" style="text-align: justify;">
                {{ulasan.deskripsi}}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    document.getElementById('downloadButton').addEventListener('click', function() {
        const id_tayangan = 'example_id';  // Replace with actual id_tayangan

        fetch('/add_unduhan/{{series.id_tayangan}}', {  // Adjust the endpoint URL if necessary
            method: 'GET',
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 500) {
                    alert('Error 500: Internal Server Error. Please try again later.');
                    return Promise.reject('Internal Server Error');
                } else {
                    return response.json().then(errorData => {
                        return Promise.reject(errorData.message || 'Unknown error');
                    });
                }
            }
            return response.json();
        })
        .then(data => {
            console.log(data);
            alert('Request successful');
        })
        .catch(error => {
            console.error('Error:', error);
            if (error !== 'Internal Server Error') {
                alert('An error occurred: ' + error);
            }
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<script>
    document.getElementById('ratingForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const id_tayangan = document.getElementById('id_tayangan').value;
        const rating = document.getElementById('rating').value;
        const deskripsi = document.getElementById('deskripsi').value;

        fetch('../add_ulasan/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id_tayangan: id_tayangan,
                rating: rating,
                deskripsi: deskripsi
            })
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 500) {
                    alert('Database Tertrigger, pengguna sudah memberikan komentar');
                    return Promise.reject('Internal Server Error');
                } else {
                    return response.json().then(errorData => {
                        return Promise.reject(errorData.message || 'Unknown error');
                    });
                }
            }
            return response.json();
        })
        .then(data => {
            console.log(data);
            location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            if (error !== 'Internal Server Error') {
                alert('Database Tertrigger, pengguna sudah memberikan komentar');
            }
        });
    });
</script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
    crossorigin="anonymous"></script>
{% endblock content %}